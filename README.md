# Apache mod security log parser

## Описание скрипта mod_sec_log_parser.py
Этот скрипт предназначен для обработки и анализа логов, созданных модулем ModSecurity на веб-сервере Apache в режиме SecAuditLogType Concurrent. Он автоматически извлекает ключевые данные из логов, хранящихся в виде отдельных мелких файлов, объединяет их в один лог-файл и записывает информацию в базу данных MySQL для удобного анализа и отчётности. Скрипт также осуществляет очистку обработанных файлов и пустых директорий, поддерживая организованную файловую структуру.

### Основные функции и задачи скрипта:

1. Чтение логов: Скрипт просматривает указанный каталог (/var/log/httpd/modsec_audit/) на наличие файлов логов, созданных модулем ModSecurity, и обрабатывает их.

2. Парсинг данных: Логи разбиваются на ключевые компоненты с использованием заранее определенных регулярных выражений, чтобы извлечь важные данные, такие как метод запроса, URI, адрес клиента, идентификатор правила, сообщения об ошибках и другие сведения, касающиеся запросов.

3. Объединение логов: Все обработанные данные записываются в один общий лог-файл (/var/log/httpd/modsec_audit.log) для удобства хранения и последующего анализа.

4. Подключение к базе данных: Скрипт осуществляет соединение с базой данных MySQL для сохранения извлеченных данных в таблице logs. Это позволяет упростить анализ и отчетность о проблемах, обнаруженных ModSecurity.

5. Запись данных в базу: Извлеченные данные регистрируются в таблице базы данных с фиксированной структурой, что позволяет пользователю отслеживать информацию о безопасности в режиме реального времени.

6. Очистка файлов и директорий: После успешной обработки логов, скрипт удаляет их, чтобы избежать повторной обработки при следующем запуске. Также происходит проверка и удаление пустых подкаталогов, что позволяет поддерживать чистую и организованную файловую структуру.

### Принципы работы

- Регулярные выражения: Для парсинга логов используются регулярные выражения, которые четко определяют, каковы формы данных, которые нужно искать, обеспечивая точное извлечение информации.

- Работа с исключениями: Скрипт учитывает возможные ошибки при подключении к базе данных и читает файлы логов, обеспечивая обработку сбоев без остановки выполнения всей программы.

- Структура данных: Каждая запись в базе данных содержит важные поля, связанные с обработанным логом, включая метод запроса, URI, IP-адрес клиента, уникальный идентификатор ошибки ModSecurity и другие параметры.

### Зависимости

Скрипт требует библиотеку pymysql для взаимодействия с базой данных MySQL. Убедитесь, что она установлена в вашем окружении:

`pip install pymysql`


### Настройки

Перед запуском скрипта убедитесь, что:

- Настройки подключения к базе данных (по умолчанию localhost) правильные, и пользователь имеет соответствующие права доступа к базе modsec_logs.
- Кодировка файла логов (в скрипте используется latin-1) соответствует фактической кодировке. Если вы работаете с логами другой кодировки, убедитесь, что она правильно указана.


## Описание скрипта watch_dir.sh

Этот скрипт предназначен для мониторинга и управления правами доступа к директориям, где хранятся логи, создаваемые модулем ModSecurity на веб-сервере Apache. В режиме SecAuditLogType Concurrent модуль ModSecurity создает лог-файлы с правами, установленными пользователем, назначенным процессу Apache через директиву AssignUserId. 

### Основные функции скрипта:

- Мониторинг директории: Скрипт использует inotifywait для постоянного отслеживания в указанной директории (/var/log/httpd/modsec_audit/) на наличие новых файлов или подкаталогов.

- Обработка новых подкаталогов: При создании нового подкаталога скрипт изменяет его права доступа и владельца, устанавливая права 770 и назначая владельцем пользователя apache и группу fastsecure. Это позволяет другим пользователям и скриптам без проблем создавать файлы и подкаталоги внутри отслеживаемой директории.

- Управление процессами: Скрипт проверяет, выполняется ли он уже, используя PID-файл, предотвращая запуск нескольких экземпляров одновременно.

- Логгирование: Скрипт ведет запись в лог-файл (/var/log/httpd/watch_dir.log), фиксируя обработку новых подкаталогов.

- Очистка ресурсов: В случае прерывания (например, SIGINT или SIGTERM), скрипт корректно завершает работу и удаляет PID-файл.

Этот скрипт обеспечивает управление безопасностью и доступом к директориям, упрощая работу с логами ModSecurity, что делает его идеальным инструментом для администраторов веб-серверов.

