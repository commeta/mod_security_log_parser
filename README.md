# Apache mod security log parser

## Описание скрипта mod_sec_log_parser.py
Этот скрипт предназначен для обработки и анализа логов, созданных модулем ModSecurity на веб-сервере Apache в режиме SecAuditLogType Concurrent. Он автоматически извлекает ключевые данные из логов, хранящихся в виде отдельных мелких файлов, объединяет их в один лог-файл и записывает информацию в базу данных MySQL для удобного анализа и отчётности. Скрипт также осуществляет очистку обработанных файлов и пустых директорий, поддерживая организованную файловую структуру.

[ModSecurity Handbook: Getting Started: Chapter 4. Logging](https://www.feistyduck.com/library/modsecurity-handbook-free/online/ch04-logging.html)

[owasp-modsecurity / ModSecurity Reference Manual (v2.x)](https://github.com/owasp-modsecurity/ModSecurity/wiki/Reference-Manual-(v2.x))


### Основные функции и задачи скрипта:

1. Чтение логов: Скрипт просматривает указанный каталог (/var/log/httpd/modsec_audit/) на наличие файлов логов, созданных модулем ModSecurity, и обрабатывает их.

2. Парсинг данных: Логи разбиваются на ключевые компоненты с использованием заранее определенных регулярных выражений, чтобы извлечь важные данные, такие как метод запроса, URI, адрес клиента, идентификатор правила, сообщения об ошибках и другие сведения, касающиеся запросов.

3. Объединение логов: Все обработанные данные записываются в один общий лог-файл (/var/log/httpd/modsec_audit.log) для удобства хранения и последующего анализа.

4. Подключение к базе данных: Скрипт осуществляет соединение с базой данных MySQL для сохранения извлеченных данных в таблице logs. Это позволяет упростить анализ и отчетность о проблемах, обнаруженных ModSecurity.

5. Запись данных в базу: Извлеченные данные регистрируются в таблице базы данных с фиксированной структурой, что позволяет пользователю отслеживать информацию о безопасности в режиме реального времени.

6. Очистка файлов и директорий: После успешной обработки логов, скрипт удаляет их, чтобы избежать повторной обработки при следующем запуске. Также происходит проверка и удаление пустых подкаталогов, что позволяет поддерживать чистую и организованную файловую структуру.

### Принципы работы

- Регулярные выражения: Для парсинга логов используются регулярные выражения, которые четко определяют, каковы формы данных, которые нужно искать, обеспечивая точное извлечение информации.

- Работа с исключениями: Скрипт учитывает возможные ошибки при подключении к базе данных и читает файлы логов, обеспечивая обработку сбоев без остановки выполнения всей программы.

- Структура данных: Каждая запись в базе данных содержит важные поля, связанные с обработанным логом, включая метод запроса, URI, IP-адрес клиента, уникальный идентификатор ошибки ModSecurity и другие параметры.

### Зависимости

Скрипт требует библиотеку pymysql для взаимодействия с базой данных MySQL. Убедитесь, что она установлена в вашем окружении:

`pip install pymysql`


### Настройки

Перед запуском скрипта убедитесь, что:

- Настройки подключения к базе данных (по умолчанию localhost) правильные, и пользователь имеет соответствующие права доступа к базе modsec_logs.
- Кодировка файла логов (в скрипте используется latin-1) соответствует фактической кодировке. Если вы работаете с логами другой кодировки, убедитесь, что она правильно указана.



### Описание значений полей лог-файла ModSecurity Audit Log, которые извлекаются скриптом:

1. REQUEST_METHOD - HTTP-метод запроса (например, GET, POST, PUT, DELETE).

2. REQUEST_URI - URL-адрес запроса, который был обработан веб-сервером.

3. REMOTE_ADDR - IP-адрес клиента, который отправил запрос.

4. Host - Имя хоста, указанное в заголовке Host запроса.

5. User-Agent - Строка агента пользователя, которая идентифицирует браузер или другое устройство клиента.

6. ruleId - Идентификатор правила ModSecurity, которое сработало для этого запроса.

7. msg - Сообщение от ModSecurity, которое описывает, почему правило сработало.

8. data - Данные, которые были обнаружены ModSecurity и привели к срабатыванию правила. Например, это может быть часть URL, заголовок или тело запроса.

9. unique_id - Уникальный идентификатор запроса, который позволяет отслеживать его обработку в логах.

10. severity - Уровень серьезности срабатывания правила ModSecurity. Может быть INFO, WARNING или ERROR.

11. maturity - Оценка зрелости правила ModSecurity. Обычно используется шкала от 0 до 5, где 0 - самый низкий уровень зрелости, а 5 - самый высокий.

12. accuracy - Оценка точности правила ModSecurity. Обычно используется шкала от 0 до 5, где 0 - самый низкий уровень точности, а 5 - самый высокий.

13. responce_header - Заголовок ответа HTTP, который был отправлен клиенту.

14. Engine-Mode - Режим, в котором работал ModSecurity при обработке запроса.

15. apache_error - Ошибка Apache, которая произошла при обработке запроса.

16. created_at - Дата и время срабатывания правила ModSecurity в формате ISO 8601.

#### Пример лога ModSecurity:
```
--f3c9d4c6-B--
GET /some/resource HTTP/1.1
Host: example.com
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/87.0.4280.88 Safari/537.36
--f3c9d4c6-A--
192.168.1.10
[id "944"] [msg "Cross-site scripting attempt blocked"] [data "javascript:alert('malicious');"] [severity "WARNING"] [maturity "4"] [accuracy "4"]
--f3c9d4c6-F--
HTTP/1.1 403 Forbidden
```

##### В этом примере:

- REQUEST_METHOD - GET
- REQUEST_URI - /some/resource
- REMOTE_ADDR - 192.168.1.10
- ruleId - 944
- msg - Cross-site scripting attempt blocked
- data - javascript:alert(‘malicious’);
- severity - WARNING
- responce_header - HTTP/1.1 403 Forbidden

##### Важно:

- Точные поля, которые будут записываться в лог, могут варьироваться в зависимости от конфигурации ModSecurity и версии Apache.
- Обратите внимание на ошибки Apache-Error, так как они могут указать на проблемы с конфигурацией Apache или ModSecurity.
- Используйте эти данные для анализа и отладки безопасности вашего веб-приложения.



## Описание скрипта watch_dir.sh

Этот скрипт предназначен для мониторинга и управления правами доступа к директориям, где хранятся логи, создаваемые модулем ModSecurity на веб-сервере Apache. В режиме SecAuditLogType Concurrent модуль ModSecurity создает лог-файлы с правами, установленными пользователем, назначенным процессу Apache 2 через директиву AssignUserId с модулем MPM ITK. 

### Основные функции скрипта:

- Мониторинг директории: Скрипт использует inotifywait для постоянного отслеживания в указанной директории (/var/log/httpd/modsec_audit/) на наличие новых файлов или подкаталогов.

- Обработка новых подкаталогов: При создании нового подкаталога скрипт изменяет его права доступа и владельца, устанавливая права 770 и назначая владельцем пользователя apache и группу fastsecure. Это позволяет другим пользователям и скриптам без проблем создавать файлы и подкаталоги внутри отслеживаемой директории.

- Управление процессами: Скрипт проверяет, выполняется ли он уже, используя PID-файл, предотвращая запуск нескольких экземпляров одновременно.

- Логгирование: Скрипт ведет запись в лог-файл (/var/log/httpd/watch_dir.log), фиксируя обработку новых подкаталогов.

- Очистка ресурсов: В случае прерывания (например, SIGINT или SIGTERM), скрипт корректно завершает работу и удаляет PID-файл.

Этот скрипт обеспечивает управление безопасностью и доступом к директориям, упрощая работу с логами ModSecurity, что делает его идеальным инструментом для администраторов веб-серверов.

