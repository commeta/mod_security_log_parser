# Apache mod security log parser

[English](README.md)

## Описание скрипта mod_sec_log_parser.py
Этот скрипт предназначен для обработки и анализа логов, созданных модулем ModSecurity на веб-сервере Apache в режиме SecAuditLogType Concurrent. Он автоматически извлекает ключевые данные из логов, хранящихся в виде отдельных мелких файлов, объединяет их в один лог-файл и записывает информацию в базу данных MySQL для удобного анализа и отчётности. Скрипт также осуществляет очистку обработанных файлов и пустых директорий, поддерживая организованную файловую структуру.

Скрипты решают проблемы с использованием глобального мьютекста с модулем Apache2 MPM ITK [issues/454](https://github.com/owasp-modsecurity/ModSecurity/issues/454), [issues/712](https://github.com/owasp-modsecurity/ModSecurity/issues/712)



[ModSecurity Handbook: Getting Started: Chapter 4. Logging](https://www.feistyduck.com/library/modsecurity-handbook-free/online/ch04-logging.html)

[owasp-modsecurity / ModSecurity Reference Manual (v2.x)](https://github.com/owasp-modsecurity/ModSecurity/wiki/Reference-Manual-(v2.x))


### Основные функции и задачи скрипта:

1. Чтение логов: Скрипт просматривает указанный каталог (/var/log/httpd/modsec_audit/) на наличие файлов логов, созданных модулем ModSecurity, и обрабатывает их.

2. Парсинг данных: Логи разбиваются на ключевые компоненты с использованием заранее определенных регулярных выражений, чтобы извлечь важные данные, такие как метод запроса, URI, адрес клиента, идентификатор правила, сообщения об ошибках и другие сведения, касающиеся запросов.

3. Объединение логов: Все обработанные данные записываются в один общий лог-файл (/var/log/httpd/modsec_audit.log) для удобства хранения и последующего анализа.

4. Подключение к базе данных: Скрипт осуществляет соединение с базой данных MySQL для сохранения извлеченных данных в таблице logs. Это позволяет упростить анализ и отчетность о проблемах, обнаруженных ModSecurity.

5. Запись данных в базу: Извлеченные данные регистрируются в таблице базы данных с фиксированной структурой, что позволяет пользователю отслеживать информацию о безопасности в режиме реального времени.

6. Очистка файлов и директорий: После успешной обработки логов, скрипт удаляет их, чтобы избежать повторной обработки при следующем запуске. Также происходит проверка и удаление пустых подкаталогов, что позволяет поддерживать чистую и организованную файловую структуру.

### Принципы работы

- Регулярные выражения: Для парсинга логов используются регулярные выражения, которые четко определяют, каковы формы данных, которые нужно искать, обеспечивая точное извлечение информации.

- Работа с исключениями: Скрипт учитывает возможные ошибки при подключении к базе данных и читает файлы логов, обеспечивая обработку сбоев без остановки выполнения всей программы.

- Структура данных: Каждая запись в базе данных содержит важные поля, связанные с обработанным логом, включая метод запроса, URI, IP-адрес клиента, уникальный идентификатор ошибки ModSecurity и другие параметры.

### Зависимости

Скрипт требует библиотеку pymysql для взаимодействия с базой данных MySQL. Убедитесь, что она установлена в вашем окружении:

`pip install pymysql`


### Настройки

Перед запуском скрипта убедитесь, что:

- Настройки подключения к базе данных (по умолчанию localhost) правильные, и пользователь имеет соответствующие права доступа к базе modsec_logs.
- Кодировка файла логов (в скрипте используется latin-1) соответствует фактической кодировке. Если вы работаете с логами другой кодировки, убедитесь, что она правильно указана.



### Описание значений полей лог-файла ModSecurity Audit Log, которые извлекаются скриптом:

1. REQUEST_METHOD - HTTP-метод запроса (например, GET, POST, PUT, DELETE).

2. REQUEST_URI - URL-адрес запроса, который был обработан веб-сервером.

3. REMOTE_ADDR - IP-адрес клиента, который отправил запрос.

4. Host - Имя хоста, указанное в заголовке Host запроса.

5. User-Agent - Строка агента пользователя, которая идентифицирует браузер или другое устройство клиента.

6. ruleId - Идентификатор правила ModSecurity, которое сработало для этого запроса.

7. msg - Сообщение от ModSecurity, которое описывает, почему правило сработало.

8. data - Данные, которые были обнаружены ModSecurity и привели к срабатыванию правила. Например, это может быть часть URL, заголовок или тело запроса.

9. unique_id - Уникальный идентификатор запроса, который позволяет отслеживать его обработку в логах.

10. severity - Уровень серьезности срабатывания правила ModSecurity. Может быть EMERGENCY (0), ALERT (1), CRITICAL (2), ERROR (3), WARNING (4), NOTICE (5), INFO (6) and DEBUG (7).

11. maturity - Оценка зрелости правила ModSecurity. Обычно используется шкала от 1 до 9, где 1 - самый низкий уровень зрелости, а 9 - самый высокий.

12. accuracy - Оценка точности правила ModSecurity. Обычно используется шкала от 1 до 9, где 1 - самый низкий уровень точности, а 9 - самый высокий.

13. responce_header - Заголовок ответа HTTP, который был отправлен клиенту.

14. Engine-Mode - Режим, в котором работал ModSecurity при обработке запроса.

15. Score - Total Inbound Score: Это общий балл аномалий, вычисленный ModSecurity для данного запроса. Чем выше балл, тем подозрительнее поведение пользователя.

16. SQLi - Количество аномалий, связанных с потенциальными SQL-инъекциями.

17. XSS - Количество аномалий, связанных с потенциальными атаками типа XSS (Cross-Site Scripting).

18. phase - Фаза, этап обработки запроса: Фаза 1: Заголовки запроса, Фаза 2: Тело запроса, Фаза 3: Заголовки ответа, Фаза 4: Тело ответа, Фаза 5: Логирование

19. created_at - Дата и время срабатывания правила ModSecurity в формате ISO 8601.

#### Пример лога ModSecurity:
```
--f3c9d4c6-B--
GET /some/resource HTTP/1.1
Host: example.com
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/87.0.4280.88 Safari/537.36
--f3c9d4c6-A--
192.168.1.10
[id "944"] [msg "Cross-site scripting attempt blocked"] [data "javascript:alert('malicious');"] [severity "WARNING"] [maturity "4"] [accuracy "4"]
--f3c9d4c6-F--
HTTP/1.1 403 Forbidden
```

##### В этом примере:

- REQUEST_METHOD - GET
- REQUEST_URI - /some/resource
- REMOTE_ADDR - 192.168.1.10
- ruleId - 944
- msg - Cross-site scripting attempt blocked
- data - javascript:alert(‘malicious’);
- severity - WARNING
- responce_header - HTTP/1.1 403 Forbidden

##### Важно:

- Точные поля, которые будут записываться в лог, могут варьироваться в зависимости от конфигурации ModSecurity и версии Apache.
- Обратите внимание на ошибки Apache-Error, так как они могут указать на проблемы с конфигурацией Apache или ModSecurity.
- Используйте эти данные для анализа и отладки безопасности вашего веб-приложения.



## Описание параметра Mutex в конфигурации Apache

Параметр Mutex в конфигурации Apache используется для управления доступом к ресурсам в многопоточной среде. Он позволяет избежать состояний гонки (race conditions) и обеспечивает безопасный доступ к общим ресурсам между разными процессами или потоками.

### Синтаксис
`Mutex file:/var/run/mod_security default`

Строка указывает на использование файлового мьютекса, который будет храниться в директории /var/run/mod_security/. Важно, чтобы эта директория существовала и имела правильные права доступа, так как она будет использоваться для создания файла мьютекса.

### Права доступа
Так как мьютекс является глобальным ресурсом, каталог, в котором создается файл мьютекса, должен иметь права доступа, позволяющие всем необходимым процессам (например, веб-серверу и модулям) взаимодействовать с ним. Это означает, что права на каталог должны быть установлены так, чтобы все пользователи, которым необходимо использовать этот мьютекс, могли его читать, записывать и выполнять поиск.

Пример команды для установки прав:
```
chmod 770 /var/run/mod_security
chown <owner>:<group> /var/run/mod_security
```

Замените <owner> и <group> на соответствующие значения для вашего окружения. В данном примере каталог с мьютексом должен быть доступен для чтения, записи и поиска для владельца и группы, в которой состоят пользователи Apache 2, назначенные через AssignUserId в MPM ITK.

### Как работает Mutex
1. **Создание мьютекса:** При старте Apache модуль ModSecurity создает файл мьютекса в указанной директории. Этот файл служит индикатором того, что ресурс занят.
2. **Блокировка ресурсов:** Когда один из процессов или потоков пытается получить доступ к ресурсу (например, к конфигурации правил ModSecurity), он обращается к этому мьютексу. Если другой процесс уже использует этот ресурс, текущий процесс будет заблокирован до тех пор, пока ресурс не станет доступным.
3. **Освобождение мьютекса:** После завершения работы с ресурсом процесс освобождает мьютекс, позволяя другим процессам продолжать выполнение.

### Участие в логах ModSecurity
Мьютекс также играет важную роль в работе с логами ModSecurity:
- **Синхронизация записей:** Когда несколько процессов Apache обрабатывают запросы одновременно, они могут пытаться записать логи в один и тот же файл. Мьютекс обеспечивает синхронизацию этих операций, предотвращая повреждение данных в логах из-за одновременной записи.
- **Предотвращение конфликтов:** Без использования мьютекса возможны ситуации, когда один процесс может перезаписать данные, которые другой процесс пытается записать, что приводит к потерям информации или некорректным записям.

Таким образом, использование параметра Mutex в конфигурации Apache для ModSecurity помогает обеспечить стабильность и целостность работы сервера в многопоточной среде, а также корректность ведения логов.


## Описание скрипта watch_dir.sh

Этот скрипт предназначен для мониторинга и управления правами доступа к директориям, где хранятся логи, создаваемые модулем ModSecurity на веб-сервере Apache. В режиме SecAuditLogType Concurrent модуль ModSecurity создает лог-файлы с правами, установленными пользователем, назначенным процессу Apache 2 через директиву AssignUserId с модулем MPM ITK. 

### Основные функции скрипта:

- Мониторинг директории: Скрипт использует inotifywait для постоянного отслеживания в указанной директории (/var/log/httpd/modsec_audit/) на наличие новых файлов или подкаталогов.

- Обработка новых подкаталогов: При создании нового подкаталога скрипт изменяет его права доступа и владельца, устанавливая права 770 и назначая владельцем пользователя apache и группу fastsecure. Это позволяет другим пользователям и скриптам без проблем создавать файлы и подкаталоги внутри отслеживаемой директории.

- Управление процессами: Скрипт проверяет, выполняется ли он уже, используя PID-файл, предотвращая запуск нескольких экземпляров одновременно.

- Логгирование: Скрипт ведет запись в лог-файл (/var/log/httpd/watch_dir.log), фиксируя обработку новых подкаталогов.

- Очистка ресурсов: В случае прерывания (например, SIGINT или SIGTERM), скрипт корректно завершает работу и удаляет PID-файл.

Этот скрипт обеспечивает управление безопасностью и доступом к директориям, упрощая работу с логами ModSecurity, что делает его идеальным инструментом для администраторов веб-серверов.

## Описание скрипта modsec_recedive.sh - блокировка повторных нарушений

### Описание:

Этот скрипт (modsec_recedive.sh) предназначен для мониторинга логов ModSecurity и блокировки IP-адресов, которые совершают многократные атаки.

### Архитектура:

- ModSecurity: Модуль Apache, который анализирует входящий трафик и блокирует вредоносные запросы.
- ModSec Recedive: Скрипт, который анализирует логи ModSecurity, определяет частоту атак с определенного IP-адреса и блокирует IP-адреса, превысившие заданный порог.
- Fail2ban: Программа, которая использует правила для блокировки IP-адресов, которые совершают многократные атаки на определенный сервис.

### Как использовать:

- Настройка ModSecurity: Убедитесь, что ModSecurity установлен и настроен на запись логов в директорию "/var/log/httpd/modsec_audit/".
- Установка скрипта: Сохраните скрипт modsec_recedive.sh в желаемое место.
- Настройка параметров:
- - WATCH_DIR: Путь к директории с логами ModSecurity.
- - LOG_FILE: Путь к файлу, где хранится информация о количестве атак с каждого IP.
- - RECEDIVE_FILE: Путь к файлу, где хранятся IP-адреса, которые нужно заблокировать.
- - TIMEOUT: Период времени (в секундах), после которого информация об атаках из логов ModSecurity удаляется.
- - ATTACK_THRESHOLD: Число атак с одного IP-адреса, после которого он попадает в RECEDIVE_FILE и может быть заблокирован.
- Запуск скрипта: Запустите скрипт: ./modsec_recedive.sh.
- Настройка Fail2ban (необязательно): Создайте файл правил Fail2ban, который будет использовать информацию из RECEDIVE_FILE для блокировки IP-адресов.

### Пример использования Fail2ban:

```
[ModSec Recedive]
enabled  = true
port  = http,https
filter   = modsec_recedive
logpath  = /var/log/httpd/modsec_recedive.log
maxretry = 3
bantime  = 3600
findtime = 600
```
### Преимущества:

- Уменьшение ложных срабатываний: Мониторинг количества атак с одного IP-адреса позволяет сократить ложные срабатывания и блокировать только действительно злонамеренные действия.
- Более эффективная защита: Блокировка IP-адресов, которые совершают многократные атаки, снижает нагрузку на сервер и повышает уровень защиты.
- Гибкая настройка: Вы можете легко настраивать параметры скрипта в соответствии с потребностями вашей системы.


## Директивы конфигурации ModSecurity

Следующие директивы являются ключевыми для правильного функционирования модуля ModSecurity на вашем веб-сервере Apache. Эти настройки обеспечивают эффективную работу системы аудита, особенно в режиме Concurrent SecAuditLogType.

### Директивы конфигурации:
```
<IfModule mod_security2.c>
    # Эта директива указывает тип аудита.
    SecAuditLogType Concurrent
    
    # Устанавливает права доступа к директории для аудита.
    SecAuditLogDirMode 0777
    
    # Устанавливает права доступа к файлам аудита.
    SecAuditLogFileMode 0600

    # Эти директивы определяют временную директорию и директорию данных для ModSecurity.
    SecTmpDir /var/lib/mod_security
    SecDataDir /var/lib/mod_security
    
    # Указывает директорию для хранения аудита.
    SecAuditLogStorageDir /var/log/httpd/modsec_audit
</IfModule>
```

### Объяснение директив:

- **SecAuditLogType Concurrent**: Эта директива устанавливает тип аудита в Concurrent, позволяя нескольким процессам одновременно записывать логи без конфликтов.

- **SecAuditLogDirMode 0777**: Устанавливает права доступа к директории аудита, позволяя полный доступ всем пользователям. Это необходимо для параллельной записи, но должно быть осторожно управляемо для поддержания безопасности.

- **SecAuditLogFileMode 0600**: Ограничивает доступ к файлам аудита, позволяя только владельцу (обычно пользователю Apache) читать и записывать в эти файлы, что повышает уровень безопасности.

- **SecTmpDir и SecDataDir**: Эти директивы указывают временные и данные директории, используемые ModSecurity. Они должны быть установлены на соответствующие пути, где ModSecurity может безопасно хранить временные файлы.

- **SecAuditLogStorageDir**: Определяет директорию, где будут храниться аудиторские логи. Убедитесь, что у этой директории установлены правильные права доступа для корректного ведения логов.

### Важное примечание:
Обязательно просмотрите и настройте права доступа в соответствии с вашими политиками безопасности. Хотя 0777 позволяет гибко вести параллельные записи, это может представлять собой риски безопасности, если не контролировать ситуацию.
